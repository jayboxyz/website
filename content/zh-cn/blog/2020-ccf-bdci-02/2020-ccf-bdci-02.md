+++
title = "黑盒调优，我们用它优化openLooKeng对接Hive数据源的执行效率"
date = "2021-02-01"
tags = ["大数据", "数据虚拟化", "openLooKeng"]
archives = "2021-01"
author = "进击的巨人"
description = "2020 CCF大数据与计算智能大赛单赛题奖项中，参与openLooKeng赛题的3支队伍荣获大赛的一、二等奖。本期，荣获二等奖的团队将带来关于赛题「openLooKeng性能优化」的分享。让我们一睹这支队伍的风采。"
+++


### 前言

2020 CCF大数据与计算智能大赛单赛题奖项中，参与openLooKeng赛题的3支队伍荣获大赛的一、二等奖。本期，荣获二等奖的团队将带来关于赛题「openLooKeng性能优化」的分享。让我们一睹这支队伍的风采。

### 团队简介

团队名称：进击的巨人
团队成员：
刘  祥  中国科学技术大学计算机学院，研究生一年级
邱明璞  中国科学技术大学信息科学技术学院，研究生一年级
秦杰杰  东北大学计算机科学与技术专业，研究生一年级

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-01.jpg" >

### 2020 CCF BDCI大数据与计算智能大赛

### 赛题 | openLooKeng 性能优化

#### BY 进击的巨人

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-02.jpg" >

### 方案思路

我们本次设计主要是<strong>面向openLooKeng对接Hive数据源</strong><p class="gray">（文件采用ORC格式）</p><strong>的执行效率优化</strong>，具体的测试指标是openLooKeng引擎执行完100个sql语句的总时间。

由于测试方式的特殊性，使用面向通用查询的openLooKeng参数可能不会带来最优的查询效率，我们使用黑盒调优的方式。

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-03.jpg" >

首先建立openLooKeng查询执行时间与任务类型<p class="gray">（0~99个查询）</p>，集群参数<p class="gray">（节点数，核数，内存（只考虑同构情况））</p>，openLooKeng参数之间的性能模型，即求解函数：

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-04.jpg" >

其中，T代表任务的运行时间，c为集群参数，包括节点数，每个节点的核数和内存数，t为任务类型<p class="gray">（0~99，分别代表100个任务）</p>，p代表openLooKeng的参数，这里选取了19个影响比较大的参数<p class="gray">（包括openLooKeng查询的基本配置参数和关于hive连接器的相关配置参数）</p>。

每个参数都在其取值范围内均匀产生随机数，在集群上开辟相应资源的容器<p class="gray">（与集群参数相关）</p>去运行相应的任务，采集运行时间，把参数和最终的运行时间存入训练集库。使用MATLAB的Regression Learner APP中的常用回归模型进行拟合，找到拟合最好的回归模型并保存。

我们的目标是使100个查询任务的运行时间和最短，即最小化目标函数：

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-05.jpg" >

在集群参数c未知的情况下，我们可以使用以下策略求得相对较优的解：集群参数在合理的范围内均匀取值，每个集群参数都可以在参数的搜索空间中采用多起点爬山算法去搜索到一个最优的p，然后对所有的p取均值，最后得到最优的openLooKeng参数作为最后的配置参数。

若测试集群的配置已知，则在集群参数代入后，我们可将目标函数简化为：

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-06.jpg" >

可以直接使用搜索算法求取最优的p，使得目标函数最小。我们采用的搜索算法是带限制条件的多起点爬山算法，可以在可行的时间内搜索到质量较优的解。

<img src="/zh-cn/blog/2020-ccf-bdci-02/2021-02-01-ccf-07.jpg" >

算法是在爬山算法的基础上运行多次，直到连续三次收敛到的局部最优解都不比之前搜索到的最优解更优，则结束搜索，并认为当前最优解即是我们需要的最优解。

### 总结

总的来说，结合性能建模和最优化搜索可以得到基本上最优的参数组合，在没有改动源码的基础上也能针对特定的运行环境和特定的测试集产生不错的优化效果<p class="gray">（5%以上）</p>。

而且由于性能建模会随着数据集的增多越来越准确，最优化搜索算法经过优化之后，也能在很短的时间内<p class="gray">（20s）</p>左右给出一个相对较优解。因此，对于参数敏感的黑盒系统都具有不错的调优效果。


